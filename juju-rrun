#!/usr/bin/env python
#
# Copyright 2015 Felipe Reyes <felipe.reyes@canonical.com>
#
# juju-rrun is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# juju-clean is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# For a full copy of the GNU General Public License, see
# <http://www.gnu.org/licenses/>.
#
# This plugin pretty prints stdout/stderr generated by 'juju run'
#

from __future__ import print_function
import json
import subprocess
import sys

separator = '----------'


def print_help():
    print('Pretty print of juju run output')
    sys.exit(1)


def print_description():
    print("Usage: juju rrun [options] <commands>")
    print("Pretty print of juju run output")
    print("")
    print("Options are passed directly to 'juju run', so any option supported")
    print("it will work for juju rrun")
    sys.exit(1)


def main():

    if len(sys.argv) == 1 or sys.argv[1] == '--help':
        print_help()

    if len(sys.argv) == 1 or sys.argv[1] == '--description':
        print_description()

    cmd = ['juju', 'run', '--format', 'json'] + sys.argv[1:]
    output = subprocess.check_output(cmd)
    data = json.loads(output)

    for item in data:
        print(separator, item['MachineId'], item['UnitId'])

        if item.get('Stderr'):
            print(separator, 'stderr', separator)
            print(item['Stderr'])

        print(separator, 'stdout', separator)
        print(item['Stdout'])


if __name__ == '__main__':
    main()
